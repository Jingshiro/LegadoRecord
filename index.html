<!DOCTYPE html>
<html lang="zh-CN" data-theme="classic">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Legado 阅读分析</title>
    <!-- 字体引入 -->
    <link rel="stylesheet" href="https://fontsapi.zeoseven.com/79/main/result.css">
    <link rel="stylesheet" href="https://fontsapi.zeoseven.com/268/main/result.css">

    <style>
        /* --- 1. 基础预设与变量 (主题配置) --- */
        :root {
            --font-main: "Clear Han Serif", "PingFang SC", serif;
            --font-logo: "Nyushu Firmia", cursive;
            
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-pill: 50px;
            
            --transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* 主题：素雅白 (默认) */
        [data-theme="elegant"] {
            --bg-body: #F9F9F7;
            --bg-card: #FFFFFF;
            --bg-input: #F2F2F0;
            --primary: #58665B; 
            --primary-fade: #EDF0EE;
            --text-main: #2C2C2C;
            --text-sub: #888888;
            --border: #E6E6E6;
            --accent: #8B5F5F;
            --shadow: 0 8px 30px rgba(0,0,0,0.04);
            --title-color: #2C2C2C;
        }

        /* 主题：经典绿 (优化标题色) */
        [data-theme="classic"] {
            --bg-body: #F2F2EF;      
            --bg-card: #FFFFFF;      
            --bg-input: #F5F5F5;     
            --primary: #6B8E6B;      
            --primary-fade: #EBF0EB; 
            --text-main: #333333;    
            --text-sub: #888888;     
            --border: #E0E0E0;       
            --accent: #d9534f;       
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --title-color: #4A6E4A; /* 专门加深的绿色标题 */
        }

        /* 主题：古籍黄 */
        [data-theme="vintage"] {
            --bg-body: #F0EAD6; 
            --bg-card: #FAF6E8;
            --bg-input: #E6DFCC;
            --primary: #5C4033; 
            --primary-fade: #EBE3D3;
            --text-main: #3E3027;
            --text-sub: #8C7B70;
            --border: #D6CDB8;
            --accent: #A84936;
            --shadow: 0 8px 30px rgba(62, 48, 39, 0.06);
            --title-color: #3E3027;
        }

        /* 主题：静谧黑 */
        [data-theme="dark"] {
            --bg-body: #1A1A1A;
            --bg-card: #252525;
            --bg-input: #333333;
            --primary: #A8B5A8; 
            --primary-fade: #333833;
            --text-main: #E0E0E0;
            --text-sub: #888888;
            --border: #3A3A3A;
            --accent: #C78D8D;
            --shadow: 0 8px 30px rgba(0,0,0,0.3);
            --title-color: #E0E0E0;
        }

        /* 新增主题：极简灰 */
        [data-theme="gray"] {
            --bg-body: #F0F2F5;
            --bg-card: #FFFFFF;
            --bg-input: #F0F2F5;
            --primary: #607D8B; 
            --primary-fade: #ECEFF1;
            --text-main: #263238;
            --text-sub: #90A4AE;
            --border: #CFD8DC;
            --accent: #546E7A;
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
            --title-color: #37474F;
        }

        /* 新增主题：深海蓝 */
        [data-theme="blue"] {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --primary: #38bdf8; 
            --primary-fade: #1e3a8a;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --border: #334155;
            --accent: #f472b6;
            --shadow: 0 8px 30px rgba(0,0,0,0.4);
            --title-color: #38bdf8;
        }

        /* 新增主题：马卡龙 */
        [data-theme="macaron"] {
            --bg-body: #FFF0F5;
            --bg-card: #FFFFFF;
            --bg-input: #FFF5F7;
            --primary: #FFB7B2; 
            --primary-fade: #FFF0F0;
            --text-main: #6D5B5B;
            --text-sub: #B4A0A0;
            --border: #FFDAC1;
            --accent: #E2F0CB;
            --shadow: 0 8px 30px rgba(255, 183, 178, 0.2);
            --title-color: #FF9AA2;
        }


        /* --- 2. 全局样式 --- */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: var(--font-main);
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: background-color 0.5s ease, color 0.5s ease;
            font-weight: normal;
            letter-spacing: 0.02em;
        }

        .container { 
            width: 100%; 
            max-width: 700px; 
            position: relative; 
            z-index: 1; 
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- 3. 头部与主题切换 (优化版) --- */
        header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 将主题切换改为流式布局，放在标题上方，居中 */
        .theme-switcher {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-pill);
            border: 1px solid var(--border);
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .theme-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }
        .theme-dot:hover { transform: scale(1.1); }
        /* 选中状态指示 */
        [data-theme="elegant"] .theme-dot[data-set="elegant"],
        [data-theme="classic"] .theme-dot[data-set="classic"],
        [data-theme="vintage"] .theme-dot[data-set="vintage"],
        [data-theme="dark"] .theme-dot[data-set="dark"],
        [data-theme="gray"] .theme-dot[data-set="gray"],
        [data-theme="blue"] .theme-dot[data-set="blue"],
        [data-theme="macaron"] .theme-dot[data-set="macaron"] {
            border-color: var(--text-main);
            transform: scale(1.1);
        }

        .theme-dot[data-set="elegant"] { background: #F9F9F7; box-shadow: inset 0 0 0 1px #ddd;}
        .theme-dot[data-set="classic"] { background: #6B8E6B; }
        .theme-dot[data-set="vintage"] { background: #F0EAD6; }
        .theme-dot[data-set="dark"] { background: #333; border: 1px solid #555; }
        .theme-dot[data-set="gray"] { background: #607D8B; }
        .theme-dot[data-set="blue"] { background: #38bdf8; }
        .theme-dot[data-set="macaron"] { background: linear-gradient(135deg, #FF9AA2, #E2F0CB); }

        .app-title {
            font-family: var(--font-logo);
            font-size: 42px;
            color: var(--title-color); /* 使用特定变量 */
            margin-bottom: 4px;
            font-weight: normal;
            letter-spacing: 0.1em;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.02);
            transition: color 0.3s;
        }

        .app-subtitle {
            font-size: 14px;
            color: var(--text-sub);
            letter-spacing: 0.1em;
            text-transform: uppercase;
        }

        /* --- 4. 上传与功能区 --- */
        .upload-box {
            background-color: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 80px 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow);
            margin-top: 10px;
        }
        .upload-box:hover { 
            border-color: var(--primary); 
            transform: translateY(-2px);
        }
        
        /* 筛选栏 (优化移动端) */
        .filter-bar {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px; /* 间距调小 */
            margin-bottom: 20px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.6s ease;
        }
        .filter-bar.show { opacity: 1; transform: translateY(0); }

        .filter-pill {
            padding: 6px 16px; /* 默认内边距 */
            border-radius: var(--radius-pill);
            font-size: 14px;
            cursor: pointer;
            background: transparent;
            color: var(--text-sub);
            border: 1px solid var(--border);
            transition: var(--transition);
            white-space: nowrap; /* 防止文字换行 */
        }
        .filter-pill:hover { border-color: var(--primary); color: var(--primary); }
        .filter-pill.active {
            background: var(--primary);
            color: var(--bg-card);
            border-color: var(--primary);
        }

        /* 移动端特定优化 */
        @media (max-width: 480px) {
            .app-title { font-size: 32px; } /* 缩小标题 */
            .upload-box { padding: 50px 20px; }
            
            .filter-bar {
                gap: 6px; /* 手机上间距更紧凑 */
            }
            .filter-pill {
                padding: 5px 12px; /* 缩小按钮内边距 */
                font-size: 12px;   /* 缩小字号 */
                flex: 1 0 auto;    /* 允许按钮自动伸缩 */
                text-align: center;
            }
            .stats-grid {
                gap: 10px;
            }
            .stat-value { font-size: 22px; }
        }

        .date-picker-group {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            font-size: 13px;
            color: var(--text-main);
            animation: fadeIn 0.3s ease;
            flex-wrap: wrap;
        }
        .date-input {
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-main);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: inherit;
            max-width: 130px; /* 限制宽度适配手机 */
        }

        /* --- 5. 数据展示 --- */
        .section-title {
            display: flex;
            align-items: center;
            margin: 30px 0 15px;
            font-size: 16px;
            color: var(--primary);
            font-weight: bold;
            letter-spacing: 0.05em;
        }
        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
            margin-left: 15px;
            opacity: 0.6;
        }

        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 20px; 
            margin-bottom: 30px; 
        }
        .stat-card { 
            background: var(--bg-card); 
            padding: 15px 5px; 
            border-radius: var(--radius-lg); 
            text-align: center; 
            border: 1px solid var(--border);
            transition: var(--transition);
        }
        .stat-card:hover { border-color: var(--primary); }
        
        .stat-value { 
            font-size: 26px; 
            font-weight: normal; 
            margin-bottom: 5px; 
            color: var(--text-main);
            font-family: var(--font-main);
        }
        .stat-label { font-size: 11px; color: var(--text-sub); letter-spacing: 1px; }

        .list-container { 
            background: var(--bg-card); 
            border-radius: var(--radius-lg); 
            padding: 10px 0; 
            border: 1px solid var(--border);
            min-height: 100px; 
        }
        
        .book-item { 
            padding: 14px 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            transition: background 0.2s;
        }
        .book-item:last-child { border-bottom: none; }
        .book-item:hover { background: var(--primary-fade); }
        
        .book-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .book-title { 
            max-width: 75%; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: var(--text-main);
        }
        .book-time { color: var(--text-sub); font-size: 13px; font-variant-numeric: tabular-nums; }
        
        .progress-bg { height: 3px; background: var(--bg-input); width: 100%; border-radius: 2px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0; transition: width 1s cubic-bezier(0.22, 1, 0.36, 1); border-radius: 2px; }

        /* --- 6. AI 按钮与弹窗 --- */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: var(--transition);
            z-index: 100;
            color: var(--primary);
        }
        .fab:hover { transform: translateY(-3px); border-color: var(--primary); color: var(--accent); }
        .fab svg { width: 24px; height: 24px; fill: currentColor; }
        .fab.hidden { transform: scale(0); opacity: 0; pointer-events: none; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3);
            backdrop-filter: blur(5px);
            z-index: 200;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }

        .modal-card {
            width: 90%;
            max-width: 550px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            transform: scale(0.98);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            max-height: 85vh;
            border: 1px solid var(--border);
        }
        .modal-overlay.open .modal-card { transform: scale(1); }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title { font-size: 18px; color: var(--primary); font-weight: bold; letter-spacing: 1px; }
        .close-btn { cursor: pointer; opacity: 0.5; transition: 0.2s; }
        .close-btn:hover { opacity: 1; color: var(--accent); }

        .modal-tabs { display: flex; border-bottom: 1px solid var(--border); }
        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 12px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-sub);
            transition: 0.2s;
            background: transparent;
        }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); font-weight: bold; }

        .modal-body { padding: 20px; overflow-y: auto; }
        
        .form-label { display: block; font-size: 13px; color: var(--text-main); margin-bottom: 8px; font-weight: bold; }
        .form-input, .form-textarea, .form-select {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            padding: 10px;
            font-size: 14px;
            color: var(--text-main);
            transition: 0.2s;
            font-family: inherit;
            resize: vertical;
        }
        .form-input:focus, .form-textarea:focus { background: var(--bg-card); border-color: var(--primary); }

        .style-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
        .style-tag {
            font-size: 12px; padding: 6px 10px; border-radius: var(--radius-md);
            background: var(--bg-input); color: var(--text-sub);
            cursor: pointer; border: 1px solid transparent;
            transition: all 0.2s;
        }
        .style-tag:hover { border-color: var(--primary); color: var(--primary); }
        .style-tag.selected { background: var(--primary); color: var(--bg-card); }

        .ai-result {
            margin-top: 20px;
            background: var(--bg-input);
            padding: 15px;
            border-radius: var(--radius-md);
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-main);
            min-height: 60px;
            white-space: pre-wrap;
            border-left: 2px solid var(--primary);
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .btn { padding: 8px 20px; border-radius: var(--radius-md); font-size: 14px; cursor: pointer; border: 1px solid transparent; transition: 0.2s; background: transparent;}
        .btn-cancel { color: var(--text-sub); border-color: var(--border); }
        .btn-cancel:hover { border-color: var(--text-main); color: var(--text-main); }
        .btn-primary { background: var(--primary); color: var(--bg-card); }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

        .d-none { display: none !important; }

        /* --- 7. 页脚与水印 --- */
        footer {
            margin-top: 50px;
            padding: 20px 0;
            text-align: center;
            border-top: 1px solid var(--border);
            width: 100%;
            font-size: 12px;
            color: var(--text-sub);
        }
        footer a {
            color: var(--primary);
            text-decoration: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 5px;
        }
        footer a:hover { opacity: 1; text-decoration: underline; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .ai-loading { animation: pulse 1.5s infinite; font-style: italic; color: var(--text-sub); }

    </style>
</head>
<body>

    <div class="container">
        <!-- 头部 (布局调整) -->
        <header>
            <!-- 主题调色盘 (位置调整到上方，居中) -->
            <div class="theme-switcher">
                <div class="theme-dot" data-set="classic" title="经典绿"></div>
                <div class="theme-dot" data-set="elegant" title="素雅白"></div>
                <div class="theme-dot" data-set="vintage" title="古籍黄"></div>
                <div class="theme-dot" data-set="gray" title="极简灰"></div>
                <div class="theme-dot" data-set="blue" title="深海蓝"></div>
                <div class="theme-dot" data-set="macaron" title="马卡龙"></div>
                <div class="theme-dot" data-set="dark" title="静谧黑"></div>
            </div>
            <h1 class="app-title">阅读数据分析</h1>
            <div class="app-subtitle">Analysis for Legado</div>
        </header>

        <!-- 文件上传区 -->
        <div class="upload-box" id="uploadBox">
            <svg style="width: 48px; height: 48px; fill: var(--text-sub); margin-bottom: 16px; opacity: 0.5;" viewBox="0 0 24 24">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4 6h-4v2h4v-2zm-4 4h4v2h-4v-2zm-4-4h2v2H7V9zm0 4h2v2H7v-2z"></path>
            </svg>
            <div style="color: var(--text-sub); font-size: 15px; letter-spacing: 1px;">点击上传 Legado 备份 JSON</div>
            <input type="file" id="fileInput" accept=".json" style="display:none;">
        </div>

        <!-- 主界面 -->
        <div id="dashboard" class="d-none">
            
            <!-- 筛选栏 -->
            <div class="filter-bar show">
                <div class="filter-pill active" data-type="all">全部</div>
                <div class="filter-pill" data-type="year">本年</div>
                <div class="filter-pill" data-type="month">本月</div>
                <div class="filter-pill" data-type="week">本周</div>
                <div class="filter-pill" data-type="custom">自定义</div>
            </div>
            <div class="date-picker-group" id="customDateGroup">
                <input type="date" id="startDate" class="date-input">
                <span style="opacity:0.5">-</span>
                <input type="date" id="endDate" class="date-input">
                <button class="btn btn-primary" id="applyDateBtn" style="padding: 4px 12px; font-size: 12px;">应用</button>
            </div>

            <!-- 数据概览 -->
            <div class="section-title">数据概览</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalTime">0.0</div>
                    <div class="stat-label">总时长 (小时)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="bookCount">0</div>
                    <div class="stat-label">阅读本数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgTime">0</div>
                    <div class="stat-label">平均时长 (分)</div>
                </div>
            </div>

            <!-- 排行榜 -->
            <div class="section-title">时长 Top 10</div>
            <div class="list-container" id="rankList">
                <!-- JS 渲染内容 -->
            </div>
        </div>
    </div>

    <!-- 底部页脚 -->
    <footer>
        <div style="margin-bottom: 5px;">Designed for Legado</div>
        <a href="https://github.com/Jingshiro/LegadoRecord" target="_blank">
            <svg style="width:14px;height:14px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
            Jingshiro/LegadoRecord
        </a>
    </footer>

    <!-- AI 悬浮按钮 -->
    <div class="fab hidden" id="aiFab" title="AI 分析">
        <svg viewBox="0 0 24 24"><path d="M21 6H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-10 7H8v3H6v-3H3v-2h3V8h2v3h3v2zm4.5 2c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
    </div>

    <!-- AI 弹窗 -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal-card">
            <div class="modal-header">
                <div class="modal-title">AI 读书锐评</div>
                <div class="close-btn" id="closeModal">
                    <svg style="width:24px;height:24px;fill:currentColor;" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 17.59 13.41 12z"></path></svg>
                </div>
            </div>
            
            <div class="modal-tabs">
                <div class="tab-btn active" data-tab="tab-generate">评价生成</div>
                <div class="tab-btn" data-tab="tab-settings">API 配置</div>
            </div>

            <div class="modal-body">
                <div id="tab-generate">
                    <div style="margin-bottom:15px;">
                        <label class="form-label">风格预设</label>
                        <div class="style-tags" id="styleTagsContainer"></div>
                        <textarea class="form-textarea" id="customPrompt" rows="3" placeholder="选择上方标签，或输入你想要AI扮演的角色和要求..."></textarea>
                    </div>
                    <div class="ai-result d-none" id="aiOutput"></div>
                </div>

                <div id="tab-settings" class="d-none">
                    <div style="margin-bottom:15px;">
                        <label class="form-label">API Base URL</label>
                        <input type="text" class="form-input" id="apiBaseUrl" placeholder="例如 https://api.deepseek.com">
                    </div>
                    <div style="margin-bottom:15px;">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="apiKey" placeholder="sk-...">
                    </div>
                    <div style="margin-bottom:15px;">
                        <label class="form-label">Model Name</label>
                        <input type="text" class="form-input" id="modelInput" placeholder="gpt-3.5-turbo">
                    </div>
                    <div style="font-size:12px; color:var(--text-sub);">
                        * 配置仅保存在本地浏览器中，请放心使用。
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-cancel" id="cancelBtn">取消</button>
                <button class="btn btn-primary" id="confirmBtn">开始生成</button>
            </div>
        </div>
    </div>

    <script>
        // --- 主题切换逻辑 ---
        const themeDots = document.querySelectorAll('.theme-dot');
        const html = document.documentElement;
        
        // 读取本地存储的主题
        const savedTheme = localStorage.getItem('app_theme') || 'classic'; // 默认改为classic
        html.setAttribute('data-theme', savedTheme);
        themeDots.forEach(dot => {
            dot.addEventListener('click', () => {
                const theme = dot.dataset.set;
                html.setAttribute('data-theme', theme);
                localStorage.setItem('app_theme', theme);
            });
        });

        // --- 全局变量与 DOM ---
        let allData = [];
        let currentFilteredData = [];
        let currentFilterName = "全部时间"; 
      
        // 预设 AI 风格
        const promptStyles = [
            { name: '毒舌评论', content: '风格：冷幽默、辛辣、毒舌。请根据我的阅读列表，无情地吐槽我的阅读品味，用反讽的语气指出我的问题，不要留情面。' },
            { name: '热心迷妹', content: '风格：可爱、崇拜。你是我的超级粉丝，无论我读什么你都觉得我很棒，用很多感叹号，疯狂夸赞我。' },
            { name: '哲学大师', content: '风格：深沉、哲学。请从存在主义视角分析我的阅读轨迹，用晦涩但高级的词汇，探讨我灵魂的归宿。' },
            { name: '专业分析', content: '风格：数据分析师。客观、理性。分析我的阅读时长分布、阅读类型倾向，给出阅读效率的改进建议。' },
            { name: '摸鱼鉴定', content: '风格：幽默。分析我这些书是不是在上班摸鱼时看的，计算我大概通过阅读赚了老板多少钱。' }
        ];

        // 缓存配置
        let aiConfig = {
            baseUrl: localStorage.getItem('ai_base_url') || '',
            apiKey: localStorage.getItem('ai_api_key') || '',
            model: localStorage.getItem('ai_model') || 'gpt-3.5-turbo'
        };

        const els = {
            uploadBox: document.getElementById('uploadBox'),
            fileInput: document.getElementById('fileInput'),
            dashboard: document.getElementById('dashboard'),
            filterPills: document.querySelectorAll('.filter-pill'),
            customDateGroup: document.getElementById('customDateGroup'),
            dateInputs: { start: document.getElementById('startDate'), end: document.getElementById('endDate') },
            applyDateBtn: document.getElementById('applyDateBtn'),
            stats: { totalTime: document.getElementById('totalTime'), bookCount: document.getElementById('bookCount'), avgTime: document.getElementById('avgTime') },
            rankList: document.getElementById('rankList'),
            aiFab: document.getElementById('aiFab'),
            aiModal: document.getElementById('aiModal'),
            closeModal: document.getElementById('closeModal'),
            cancelBtn: document.getElementById('cancelBtn'),
            confirmBtn: document.getElementById('confirmBtn'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            tabContents: { generate: document.getElementById('tab-generate'), settings: document.getElementById('tab-settings') },
            inputs: {
                baseUrl: document.getElementById('apiBaseUrl'),
                apiKey: document.getElementById('apiKey'),
                model: document.getElementById('modelInput'),
                styleContainer: document.getElementById('styleTagsContainer'),
                customPrompt: document.getElementById('customPrompt'),
                output: document.getElementById('aiOutput')
            }
        };

        // 初始化输入框
        els.inputs.baseUrl.value = aiConfig.baseUrl;
        els.inputs.apiKey.value = aiConfig.apiKey;
        els.inputs.model.value = aiConfig.model;
      
        // 渲染风格标签
        promptStyles.forEach(s => {
            const tag = document.createElement('div');
            tag.className = 'style-tag';
            tag.innerText = s.name;
            tag.onclick = () => {
                document.querySelectorAll('.style-tag').forEach(t => t.classList.remove('selected'));
                tag.classList.add('selected');
                els.inputs.customPrompt.value = s.content;
            };
            els.inputs.styleContainer.appendChild(tag);
        });

        // --- 文件处理 ---
        els.uploadBox.addEventListener('click', () => els.fileInput.click());
        els.uploadBox.addEventListener('dragover', (e) => { e.preventDefault(); els.uploadBox.style.borderColor = 'var(--primary)'; });
        els.uploadBox.addEventListener('dragleave', (e) => { e.preventDefault(); els.uploadBox.style.borderColor = 'var(--border)'; });
        els.uploadBox.addEventListener('drop', (e) => { e.preventDefault(); els.uploadBox.style.borderColor = 'var(--border)'; handleFile(e.dataTransfer.files[0]); });
        els.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        function handleFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const rawData = JSON.parse(e.target.result);
                    // 兼容处理：Legado备份可能是数组，也可能在对象属性里
                    const books = Array.isArray(rawData) ? rawData : (rawData.books || []);
                  
                    allData = books.map(item => {
                        const name = item.name || item.bookName || "无名书籍";
                        // 时间戳兼容：13位(ms) 或 10位(s)
                        let ts = item.latestReadTime || item.lastRead || 0;
                        if (ts > 0 && ts < 10000000000) ts *= 1000;
                      
                        // 时长兼容：通常是秒
                        let duration = item.totalReadingTime || item.readTime || 0;
                        // 极少数情况如果是毫秒转秒
                        if (duration > 100000000) duration = Math.floor(duration / 1000); 
                      
                        return { bookName: name, lastRead: ts, readTime: duration };
                    }).filter(item => item.readTime > 60); // 过滤掉阅读少于1分钟的

                    els.uploadBox.style.display = 'none';
                    els.dashboard.classList.remove('d-none');
                    els.aiFab.classList.remove('hidden');
                    applyFilter('all');
                } catch (err) {
                    alert('文件解析失败，请确保是 Legado 的 JSON 备份文件。\n错误信息: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        // --- 筛选逻辑 ---
        els.filterPills.forEach(pill => {
            pill.addEventListener('click', () => {
                els.filterPills.forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                const type = pill.dataset.type;
                currentFilterName = pill.innerText;
              
                if (type === 'custom') {
                    els.customDateGroup.style.display = 'flex';
                } else {
                    els.customDateGroup.style.display = 'none';
                    applyFilter(type);
                }
            });
        });

        els.applyDateBtn.addEventListener('click', () => {
            if(!els.dateInputs.start.value || !els.dateInputs.end.value) return;
            currentFilterName = `${els.dateInputs.start.value} 至 ${els.dateInputs.end.value}`;
            applyFilter('custom', els.dateInputs.start.value, els.dateInputs.end.value);
        });

        function applyFilter(type, startStr, endStr) {
            const now = new Date();
            now.setHours(0, 0, 0, 0); 
          
            let startTs = 0;
            let endTs = 9999999999999;

            if (type === 'year') {
                startTs = new Date(now.getFullYear(), 0, 1).getTime();
            } else if (type === 'month') {
                startTs = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            } else if (type === 'week') {
                const day = now.getDay() || 7; 
                const monday = new Date(now);
                monday.setDate(now.getDate() - day + 1);
                startTs = monday.getTime();
            } else if (type === 'custom' && startStr && endStr) {
                startTs = new Date(startStr + 'T00:00:00').getTime();
                endTs = new Date(endStr + 'T23:59:59').getTime();
            }

            currentFilteredData = allData.filter(item => {
                if (!item.lastRead && type !== 'all') return false; 
                if (!item.lastRead) return true;
                return item.lastRead >= startTs && item.lastRead <= endTs;
            });

            renderDashboard(currentFilteredData);
        }

        function renderDashboard(data) {
            // 统计
            const totalSec = data.reduce((a, b) => a + b.readTime, 0);
            els.stats.totalTime.innerText = (totalSec / 3600).toFixed(1);
            els.stats.bookCount.innerText = data.length;
            els.stats.avgTime.innerText = data.length ? Math.round((totalSec / 60) / data.length) : 0;

            // 列表
            const sorted = [...data].sort((a, b) => b.readTime - a.readTime).slice(0, 10);
            if (sorted.length === 0) {
                els.rankList.innerHTML = '<div style="text-align:center;color:var(--text-sub);padding:30px;">此时间段无阅读记录</div>';
                return;
            }

            const maxTime = sorted[0].readTime;
            els.rankList.innerHTML = sorted.map((book, i) => {
                const percent = (book.readTime / maxTime) * 100;
                return `
                <div class="book-item" style="animation: fadeUp 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; animation-delay: ${i * 0.05}s; transform: translateY(15px);">
                    <div class="book-header">
                        <span class="book-title">${i+1}. ${book.bookName}</span>
                        <span class="book-time">${(book.readTime/3600).toFixed(1)}h</span>
                    </div>
                    <div class="progress-bg"><div class="progress-bar" style="width:${percent}%"></div></div>
                </div>`;
            }).join('');
        }

        // --- AI 弹窗逻辑 ---
        const toggleModal = (show) => {
            if(show) {
                els.aiModal.classList.add('open');
            } else {
                els.aiModal.classList.remove('open');
            }
        };
        els.aiFab.onclick = () => toggleModal(true);
        els.closeModal.onclick = () => toggleModal(false);
        els.cancelBtn.onclick = () => toggleModal(false);
        els.aiModal.onclick = (e) => { if(e.target === els.aiModal) toggleModal(false); };

        // 标签页切换
        els.tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                els.tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                Object.values(els.tabContents).forEach(el => el.classList.add('d-none'));
                document.getElementById(btn.dataset.tab).classList.remove('d-none');
                els.confirmBtn.innerText = btn.dataset.tab === 'tab-settings' ? '保存设置' : '开始生成';
            });
        });

        // 生成与保存
        els.confirmBtn.addEventListener('click', async () => {
            // 如果是设置页，保存并返回
            if (!els.tabContents.settings.classList.contains('d-none')) {
                aiConfig.baseUrl = els.inputs.baseUrl.value.trim();
                aiConfig.apiKey = els.inputs.apiKey.value.trim();
                aiConfig.model = els.inputs.model.value.trim();
                localStorage.setItem('ai_base_url', aiConfig.baseUrl);
                localStorage.setItem('ai_api_key', aiConfig.apiKey);
                localStorage.setItem('ai_model', aiConfig.model);
                els.tabBtns[0].click(); // 切回生成页
                return;
            }

            // 生成页逻辑
            if (!aiConfig.baseUrl || !aiConfig.apiKey) {
                alert('请先在"API 配置"中设置您的 BaseURL 和 API Key');
                els.tabBtns[1].click();
                return;
            }
            if (currentFilteredData.length === 0) return alert('当前没有数据可供分析');

            const prompt = els.inputs.customPrompt.value.trim();
            if (!prompt) return alert('请输入或选择一个风格');

            await generateReview(prompt);
        });

        async function generateReview(systemPrompt) {
            const resultBox = els.inputs.output;
            resultBox.classList.remove('d-none');
            resultBox.innerHTML = `<div class="ai-loading">正在读取 ${currentFilterName} 的数据并思考中...</div>`;
            els.confirmBtn.disabled = true;

            // 提取摘要数据，防止Token溢出，只取Top 30
            const summaryData = currentFilteredData
                .sort((a,b) => b.readTime - a.readTime)
                .slice(0, 30) 
                .map(b => `${b.bookName} (${(b.readTime/3600).toFixed(1)}h)`)
                .join(', ');

            try {
                // 简单的 Fetch 请求
                const res = await fetch(`${aiConfig.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': `Bearer ${aiConfig.apiKey}` 
                    },
                    body: JSON.stringify({
                        model: aiConfig.model,
                        messages: [
                            { role: "system", content: `你是一个阅读分析助手。当前统计时间段：${currentFilterName}。\n用户要求：${systemPrompt}` },
                            { role: "user", content: `以下是我的阅读记录（按时长排序）：${summaryData}` }
                        ],
                        temperature: 0.7
                    })
                });

                if (!res.ok) throw new Error(`HTTP Error: ${res.status}`);
                const json = await res.json();
                const content = json.choices?.[0]?.message?.content || "AI 未返回有效内容";
              
                // 打字机效果
                resultBox.innerHTML = '';
                let i = 0; 
                const timer = setInterval(() => { 
                    resultBox.textContent += content.charAt(i++); 
                    if(i >= content.length) clearInterval(timer); 
                }, 20);

            } catch (e) {
                resultBox.innerHTML = `<span style="color:var(--accent)">请求失败: ${e.message}</span>`;
            } finally {
                els.confirmBtn.disabled = false;
            }
        }
    </script>
</body>
</html>